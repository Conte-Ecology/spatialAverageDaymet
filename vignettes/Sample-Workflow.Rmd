---
title: "Sample Workflow"
author: "Kyle O'Neil"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Sample Workflow}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

Vignettes are long form documentation commonly included in packages. Because they are part of the distribution of the package, they need to be as compact as possible. The `html_vignette` output type provides a custom style sheet (and tweaks some options) to ensure that the resulting html is as small as possible. The `html_vignette` format:

- Never uses retina figures
- Has a smaller default figure size
- Uses a custom CSS stylesheet instead of the default Twitter Bootstrap style

#collapse = TRUE}

## Load Libraries
```{r, results = "hide", warning = FALSE, message = FALSE}
library(maptools) # For reading spatial objects
library(devtools) # For package installation

install_github("Conte-Ecology/zonalDaymet")
library(zonalDaymet)
```


## Enter Common Inputs

Inputs that will be called multiple times are defined as variables.
```{r }

# Temporal range
YEARS <- 2008:2009

# Variables
VARIABLES <- c("tmin", "prcp")

# Directory containing all of the raw Daymet data
DAYMET_DIRECTORY <- "C:/CLIMATE/daymet/raw"

# Name of the database with Daymet data paired to NHDPlus catchments
DATABASE_PATH <- "C:/CLIMATE/daymet/databases/exampleDatabase"
TABLE_NAME <- "climateRecord"

ZONE_FIELD <- "FEATUREID"

```


## Download Daymet Mosaic Files

The `downloadMosaic` function connects to the THREDDS server used by Daymet to
provide the mosaic netCDF files. Individual files are downloaded by specifying
the years and variables to download for, as well as the directory to download to.
There is also an option to retry failed downloads that become corrupted. This
is a possibility if the connection is lost during the download. A progress bar 
will appear during the download as well as messages describing the existence of
downloaded netCDF files and if any are corrupt.
```{r, eval = FALSE}

downloadMosaic(years = YEARS,
                variables = VARIABLES,
                destinationFolder = file.path(DAYMET_DIRECTORY),
                retryFailedDownloads = TRUE)

```


## Spatial Data Processing

This example uses hydrologic catchment polygons as the zones over which to 
spatially average the climate records.
The `maptools` and `sp` packages are used to read and process the spatial  
layer, which should already be projected into the same coordinate system 
as the [Daymet Projection](http://daymet.ornl.gov/datasupport.html). The 
polygon layer is transformed into the geographic coordinate system before
being split into 2 x 2 degree tiles to save memory in processing.

The spatial projection arguments are 
```{r, fig.show='hold'}
# Daymet spatial reference CRS definitions (Lambert Conformal Conic).
proj4.Lambert <- "+proj=lcc +ellps=WGS84 +datum=WGS84 +lat_1=25 +lat_2=60 +lat_0=42.5 +lon_0=-100 +x_0=0 +y_0=0"  # Projected Coordinate System
proj4.WGS <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +towgs84=0,0,0"                                    # Geographic Coordinate System
```

The `maptools` package is used to read in the spatial polygons object. The 
projection argument is defined as the Daymet Projection in the Lambert 
Conformal Conic system.
```{r, eval = FALSE}
zonesShapefile <- maptools::readShapePoly("C:/CLIMATE/daymet/spatial/Catchments01_Daymet.shp", 
                                            proj4string = CRS("+proj=lcc +ellps=WGS84 +datum=WGS84 +lat_1=25 +lat_2=60 +lat_0=42.5 +lon_0=-100 +x_0=0 +y_0=0"))
```

The spatial object is transformed into the geographic coordinate system
using the `sp` package. This step ensures that the units are in lat/lon, 
making the object comparable to the coordinates provided by Daymet NetCDFs
in the World Geodetic System (WGS_84).
```{r, eval = FALSE}
transformShapefile <- sp::spTransform(zonesShapefile,
                                        CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +towgs84=0,0,0"),
                                        class = "SpatialPolygonsDataFrame")
``` 

The transformed spatial object is split apart into segments using the
`tileShapefile` function. This step is helpful with large, complex spatial
objects when processing the entire object at once will likely exceed memory 
limitations. Currently, the tile sizes are 1 x 1 and 2 x 2 degrees.
```{r, eval = FALSE}
tiledShapefile <- tileShapefile(shapefile = transformShapefile,
                                tileDegree = 1)
```

In this example, a single tile will be selected and processed.
```{r, fig.show='hold'}
zonesPolygon <- tiledShapefile[[2]]

plot(zonesPolygon)
```


## Climate Record Processing: Spatial Polygons

With the Daymet mosaics downloaded and the spatial objects loaded into R, the zonalDaymet
functions can be used to process the climate records. The `assignZonalRecordsToDatabase` 
function will spatially map the Daymet records to each polygon. If multiple records fall
inside the polygon, they will be averaged. If no points fall inside the polygon, the nearest
point will be assigned to the polygon. The function iterates through netCDF files based on
the specified variables and years to process. Results will be written to a SQLite database.
If the database does not yet exist, it gets created automatically.

```{r, eval = FALSE}

assignZonalRecordsToDatabase(zonesShapefile = zonesPolygon,
                              zoneField = ZONE_FIELD,
                              zoneFieldType = "integer",
                              mosaicDirectory = DAYMET_DIRECTORY,
                              variables = VARIABLES, 
                              years = YEARS,
                              databaseFilePath = DATABASE_PATH, 
                              databaseTableName = TABLE_NAME)
```

The `returnZonalRecordsFromDatabase` accesses the database and returns records based
on specified dates and variables. Two of the polygons are selected as an example of
how this function works.
```{r, eval = FALSE}
zones <- unique(zonesPolygon@data$FEATUREID)[1:2]

exampleZoneDB <- returnZonalRecordsFromDatabase(databaseFilePath = DATABASE_PATH, 
                                                databaseTableName = TABLE_NAME,
                                                zoneField = ZONE_FIELD,
                                                startDate = "2008-10-01",
                                                endDate = "2008-12-31",
                                                zoneIDs = zones,
                                                variables = VARIABLES)

str(exampleZoneDB)
```


The `assignZonalRecordsToDataframe` function works the same as `assignZonalRecordsToDatabase`, 
except that it writes the results to a dataframe in the R workspace. Options to specify the 
records are the same, which means that care must be taken to ensure that the output will not 
exceed memory limitations.

```{r, eval = FALSE}
exampleZoneDF <- assignZonalRecordsToDataframe(zonesShapefile = zonesPolygon,
                                                zoneField = "FEATUREID",
                                                mosaicDirectory = DAYMET_DIRECTORY,
                                                variables = c("tmin", "prcp"), 
                                                years = 2008:2009)

str(exampleZoneDF)
```



## Climate Record Processing: Coordinates

The `returnRecordsByCoordinates` function takes user defined boundaries and returns
all of the records that fall within these bounds to a dataframe in the R workspace.
It is important that the start and end dates of the record match with the netCDF
mosaic file.
```{r, eval = FALSE}
exampleCoordsLong <- returnRecordsByCoordinates(areaExtent = c(-71.0, -70.0, 42.0, 43.0),
                                                  mosaicFile = file.path(DAYMET_DIRECTORY, "prcp_2008.nc4"),
                                                  outputFormat = "long",
                                                  startDate = "2008-01-01",
                                                  endDate = "2008-01-31")
str(exampleCoordsLong)


exampleCoordsWide <- returnRecordsByCoordinates(areaExtent = c(-71.0, -70.0, 42.0, 43.0),
                                                  mosaicFile = file.path(DAYMET_DIRECTORY, "prcp_2008.nc4"),
                                                  outputFormat = "wide",
                                                  startDate = "2008-01-01",
                                                  endDate = "2008-01-31")
head(exampleCoordsWide)[1:10]

```



